---
title: 01.使用定点数查表法计算三角函数
date: 2024-09-16T02:30:00
index: true
article: false
order: 1
---

## 01.使用定点数查表法计算三角函数

- `返回值` 
  - 类型: `int16_t`
  - 映射关系：`[-32768,32767]` 表示 `[-1,1]`
  - 精度：1/32768 = 0.0000305
- `角度`
  - 类型: `uint16_t`
  - 映射关系：`[0,65535]` 表示 `[0,2PI]` 
  - 精度：360°/65535 = 0.00549°

### 具体实现

:::code-tabs
@tab `foc_utils.c`
@[code cpp](./projects/01.sin_and_cos/foc_utils.c)

@tab `foc_utils.h`
@[code cpp](./projects/01.sin_and_cos/foc_utils.h)

@tab `typedef.h`
@[code cpp](./projects/01.sin_and_cos/typedef.h)
:::


### 实现效果

![alt text](assets/images/image.png)

`01.sin_and_cos.ino`

@[code cpp](./projects/01.sin_and_cos/01.sin_and_cos.ino)



### 浮点数运算与定点数运算的耗时对比

```cpp
#include <Arduino.h>
#include <stdint.h>

void setup() {
  Serial.begin(9600);
}

#define Times 10000

void testUint32() {
  uint32_t t1 = micros(), t2;
  uint32_t temp = 1;
  for (uint32_t i = 1; i <= Times; i++) {
    temp += 1234567; // 防止编译器优化
    temp *= 1234567; // 防止编译器优化
  }
  t2 = micros();
  Serial.print("uint32_t:");
  Serial.print(temp);// 防止编译器优化
  Serial.print(',');
  Serial.print((float)(t2 - t1) / Times);
  Serial.print("us");
  Serial.println();
}

void testFloat32() {
  uint32_t t1 = micros(), t2;
  float temp = 1;
  for (uint32_t i = 1; i <= Times; i++) {
    temp += 0.001234f; // 防止编译器优化
    temp *= 1.001234f; // 防止编译器优化
  }
  t2 = micros();
  Serial.print("float:");
  Serial.print(temp); // 防止编译器优化
  Serial.print(',');
  Serial.print((float)(t2 - t1) / Times);
  Serial.print("us");
  Serial.println();
}

void loop() {
  testUint32();
  testFloat32();
}
```


**输出结果**

```bash
11:18:20.188 -> uint32_t:2763457473,5.80us
11:18:20.397 -> float:454365.65,18.69us
11:18:20.434 -> uint32_t:2763457473,5.80us
11:18:20.630 -> float:454365.65,18.69us
11:18:20.708 -> uint32_t:2763457473,5.80us
11:18:20.877 -> float:454365.65,18.69us
11:18:20.950 -> uint32_t:2763457473,5.80us
11:18:21.119 -> float:454365.65,18.69us
11:18:21.196 -> uint32_t:2763457473,5.80us
11:18:21.372 -> float:454365.65,18.69us
11:18:21.449 -> uint32_t:2763457473,5.80us
11:18:21.614 -> float:454365.65,18.69us
11:18:21.691 -> uint32_t:2763457473,5.80us
11:18:21.864 -> float:454365.65,18.69us
11:18:21.937 -> uint32_t:2763457473,5.80us
11:18:22.126 -> float:454365.65,18.69us
11:18:22.162 -> uint32_t:2763457473,5.80us
11:18:22.375 -> float:454365.65,18.69us
```

**结论**

- 在8位、16Mhz主频、无FPU浮点数计算单元的单片机上
  - Arduino UNO R3 （ATmega328P）
- 浮点数运算耗时大约是定点数耗时的3倍。